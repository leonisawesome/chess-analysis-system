<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System A: Chess Knowledge Search</title>

    <!-- Chessboard.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <!-- Chess Diagram Renderer CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/diagrams.css') }}">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .search-box {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .length-control {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            background: #fbfbfb;
        }

        .length-control-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.95em;
            margin-bottom: 10px;
            color: #2c3e50;
            font-weight: 600;
        }

        .length-slider {
            width: 100%;
            margin: 10px 0;
            accent-color: #3498db;
        }

        .length-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #95a5a6;
        }

        .length-labels span.active {
            color: #3498db;
            font-weight: 600;
        }

        .length-description {
            margin-top: 10px;
            font-size: 0.85em;
            color: #555;
        }

        .length-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #e8f4ff;
            color: #1e6fb6;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.85em;
            margin-bottom: 12px;
        }

        .search-btn {
            background: #3498db;
            color: white;
            padding: 15px 40px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .search-btn:hover {
            background: #2980b9;
        }

        .search-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #7f8c8d;
        }

        .results {
            margin-top: 30px;
        }

        .result-card {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .result-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .result-score {
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 15px;
        }

        .result-meta {
            flex: 1;
        }

        .result-book {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .result-chapter {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .result-text {
            line-height: 1.8;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }

        .chess-positions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .position-header {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .position-item {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .chessboard-container {
            max-width: 400px;
            margin: 15px 0;
        }

        .lichess-btn {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .lichess-btn:hover {
            background: #2980b9;
        }

        .position-context {
            font-size: 0.9em;
            color: #555;
            margin-top: 10px;
            font-style: italic;
        }

        .position-caption {
            margin: 15px 0;
            padding: 15px;
            background: #fff;
            border-left: 3px solid #3498db;
            font-size: 14px;
            color: #555;
            line-height: 1.7;
            border-radius: 4px;
        }

        /* Phase 6.1a: Static EPUB diagram styling */
        .epub-diagrams-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .diagrams-header {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 14px;
        }

        .diagram-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .diagram-item {
            text-align: center;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }

        .diagram-item img {
            width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            max-width: 300px;
        }

        .diagram-caption {
            font-size: 12px;
            color: #666;
            margin-top: 8px;
            font-style: italic;
            line-height: 1.4;
        }

        /* Mobile responsive */
        @media (max-width: 600px) {
            .diagram-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        /* Synthesized answer section */
        .synthesized-answer {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .answer-content {
            font-size: 16px;
            line-height: 1.8;
            color: #2c3e50;
        }

        .answer-content p {
            margin-bottom: 16px;
        }

        .answer-content p:last-child {
            margin-bottom: 0;
        }

        /* Sources section */
        .sources-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .sources-section h3 {
            margin: 0 0 15px 0;
            color: #666;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .source-item {
            background: white;
            padding: 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .source-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }

        .source-number {
            font-weight: bold;
            color: #666;
            font-size: 18px;
            min-width: 24px;
        }

        .source-score {
            background: #4CAF50;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .source-book-info {
            flex: 1;
            min-width: 0;
        }

        .source-book {
            color: #2c3e50;
            font-size: 13px;
            font-weight: 500;
            word-wrap: break-word;
            margin-bottom: 4px;
        }

        .source-chapter {
            color: #7f8c8d;
            font-size: 12px;
            font-style: italic;
        }

        .source-text {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Answer positions section */
        .answer-positions {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .answer-positions h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .answer-positions .position-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .answer-positions .chessboard-container {
            max-width: 400px;
            margin: 0 auto 15px auto;
        }

        .answer-positions .lichess-btn {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s;
            margin-bottom: 10px;
        }

        .answer-positions .lichess-btn:hover {
            background: #2980b9;
        }

        .answer-positions .position-context {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            font-style: italic;
        }

        .example-queries {
            margin-bottom: 20px;
        }

        .example-queries h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .example-btn {
            background: #ecf0f1;
            color: #2c3e50;
            padding: 8px 16px;
            margin: 5px 5px 5px 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .example-btn:hover {
            background: #bdc3c7;
        }
    </style>
</head>

<body>
    <header>
        <div class="container">
            <h1>üè∞ System A: Chess Knowledge Search</h1>
            <p class="subtitle">
                <span id="book-count">...</span> Books (<span id="chunk-count">...</span> Chunks) +
                <span id="game-count">...</span> PGN games
                ( <span id="total-count">...</span> items )
            </p>
        </div>
    </header>

    <div class="container">
        <div class="search-box">
            <div class="example-queries">
                <h3>Example Queries:</h3>
                <div id="exampleButtons"></div>
            </div>

            <input type="text" id="queryInput" class="search-input"
                placeholder="Ask a chess question... (e.g., How do I improve my calculation in the middlegame?)"
                onkeypress="if(event.key === 'Enter') search()">

            <button class="search-btn" onclick="search()" id="searchBtn">
                Search
            </button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            ‚è≥ Searching 359,095 chunks (EPUB/MOBI corpus from 937 books; PGN refresh in progress), reranking, and
            synthesizing answer with Gemini 2.0... (this may take 15-20 seconds)
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="results" class="results" style="display: none;"></div>
    </div>

    <!-- jQuery (required for chessboard.js) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Chess.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <!-- Chessboard.js -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <!-- Chess Diagram Renderer -->
    <script src="{{ url_for('static', filename='js/diagram-renderer.js') }}?v=1762009042"></script>

    <!-- INLINE FALLBACK FOR renderAnswerWithDiagrams (ITEM-024.6 Emergency Fix) -->
    <script>
        (function ensureDiagramRenderer() {
            console.log("üîß Checking for renderAnswerWithDiagrams...");

            if (typeof window.renderAnswerWithDiagrams === 'undefined') {
                console.warn("‚ö†Ô∏è External diagram-renderer.js not loaded, using inline fallback");

                window.renderAnswerWithDiagrams = function (answer, diagramPositions, container) {
                    console.log("üé® [FALLBACK] renderAnswerWithDiagrams called");
                    console.log("  Answer length:", answer?.length || 0);
                    console.log("  Diagrams:", diagramPositions?.length || 0);

                    if (!container) {
                        container = document.getElementById('answer-content-container') || document.body;
                    }

                    container.innerHTML = answer;

                    console.log("‚úÖ [FALLBACK] Answer inserted with embedded HTML");
                };
            } else {
                console.log("‚úÖ External renderAnswerWithDiagrams loaded successfully");
            }
        })();
    </script>

    <script>


        // Example queries with random selection
        const allExampleQueries = [
            "How do I improve my calculation in the middlegame?",
            "Explain the Italian Game opening",
            "Best endgame techniques for rook endings",
            "King's Indian Defense strategy",
            "How to attack in the Sicilian Defense?",
            "What is the main idea behind the London System?",
            "Explain pawn structure in the French Defense",
            "How to play knight endgames?",
            "Ruy Lopez main line variations",
            "Tactics in the Najdorf Sicilian",
            "How to improve positional understanding?",
            "Queen's Gambit Declined main plans",
            "Bishop versus knight in endgames",
            "Caro-Kann Defense strategy",
            "How to handle isolated queen's pawn positions?",
            "Attacking ideas in the King's Indian",
            "Endgame principles for beginners",
            "Slav Defense repertoire ideas",
            "How to calculate forcing variations?",
            "Nimzo-Indian Defense key concepts"
        ];

        // Fisher-Yates shuffle for proper randomization
        function getRandomQueries(arr, n) {
            const copy = [...arr];
            const result = [];
            for (let i = 0; i < n && copy.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * copy.length);
                result.push(copy[randomIndex]);
                copy.splice(randomIndex, 1);
            }
            return result;
        }

        // Function to set query in input field
        function setQuery(query) {
            document.getElementById('queryInput').value = query;
        }

        // Generate random example buttons on page load
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOMContentLoaded fired at', new Date().getTime());
            const exampleButtons = document.getElementById('exampleButtons');
            const randomQueries = getRandomQueries(allExampleQueries, 5);
            console.log('Random queries selected:', randomQueries);

            randomQueries.forEach(query => {
                const button = document.createElement('button');
                button.className = 'example-btn';
                button.textContent = query;
                button.onclick = () => setQuery(query);
                exampleButtons.appendChild(button);
            });


        });



        function search() {
            console.log("=== SEARCH FUNCTION CALLED ===");
            const query = document.getElementById('queryInput').value.trim();
            console.log("Query:", query);

            if (!query) {
                alert('Please enter a question');
                return;
            }

            // Show loading, hide error and results
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('results').innerHTML = '';
            document.getElementById('searchBtn').disabled = true;

            console.log("Sending POST request to /query_merged...");

            // Send query to backend (RRF multi-collection merge)
            fetch('/query_merged', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query })
            })
                .then(response => {
                    console.log("Response received:", response.status);
                    return response.json();
                })
                .then(data => {
                    console.log("Data received:", data);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('searchBtn').disabled = false;

                    if (data.error) {
                        showError(data.error);
                        return;
                    }

                    displayResults(data);
                })
                .catch(error => {
                    console.error("FETCH ERROR:", error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('searchBtn').disabled = false;
                    showError('An error occurred: ' + error.message);
                });
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function displayResults(data) {
            // DEBUG: Log received data
            console.log("=== RECEIVED DATA ===");
            console.log("Data keys:", Object.keys(data));
            console.log("Has diagram_positions:", 'diagram_positions' in data);
            if (data.diagram_positions) {
                console.log("Number of diagram_positions:", data.diagram_positions.length);
                if (data.diagram_positions.length > 0) {
                    console.log("First diagram:", data.diagram_positions[0]);
                }
            }
            console.log("Answer contains [DIAGRAM_ID_X]?", /\[DIAGRAM_ID_\d+\]/.test(data.answer));
            console.log("=== END DATA ===");

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';

            if (!data.answer || !data.sources) {
                resultsDiv.innerHTML = '<p class="loading">No results found</p>';
                return;
            }

            // Create answer section container
            const answerSection = document.createElement('div');
            answerSection.className = 'synthesized-answer';
            answerSection.innerHTML = `
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Answer</h2>
                <div class="answer-content" id="answer-content-container"></div>
            `;
            resultsDiv.appendChild(answerSection);

            const heading = answerSection.querySelector('h2');
            if (heading) {

            }

            // ITEM-024.6: Process answer with inline featured diagrams
            const answerContainer = document.getElementById('answer-content-container');

            // Replace [FEATURED_DIAGRAM_X] markers with actual EPUB diagram images
            let processedAnswer = data.answer;
            if (data.featured_diagrams && data.featured_diagrams.length > 0) {
                console.log(`‚úÖ Processing ${data.featured_diagrams.length} featured diagrams...`);

                data.featured_diagrams.forEach((diagram, index) => {
                    const marker = `[FEATURED_DIAGRAM_${index + 1}]`;

                    // Validation: Check if marker exists in text
                    const markerCount = (processedAnswer.match(new RegExp(marker.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g')) || []).length;
                    if (markerCount === 0) {
                        console.warn(`‚ö†Ô∏è Marker ${marker} not found in answer text`);
                    } else {
                        console.log(`üìç Found ${markerCount} occurrence(s) of ${marker}`);
                    }

                    const diagramHtml = `
                        <div class="inline-diagram" style="margin: 25px auto; text-align: center; max-width: 500px;">
                            <img src="${diagram.url}" alt="${diagram.caption}"
                                 style="max-width: 100%; height: auto; border: 2px solid #ddd; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                 onerror="this.style.display='none';">
                            <p style="font-size: 0.9em; color: #666; margin: 12px 0 0 0; line-height: 1.5; font-style: italic;">${diagram.caption}</p>
                        </div>
                    `;

                    // Use split/join for robust replacement (replaces ALL occurrences)
                    const beforeLength = processedAnswer.length;
                    processedAnswer = processedAnswer.split(marker).join(diagramHtml);
                    const afterLength = processedAnswer.length;

                    if (afterLength > beforeLength) {
                        console.log(`‚úÖ Replaced ${marker} with diagram from ${diagram.book_title}`);
                    } else {
                        console.warn(`‚ö†Ô∏è No replacement occurred for ${marker}`);
                    }
                });

                // Final validation: Check if any markers remain
                const remainingMarkers = processedAnswer.match(/\[FEATURED_DIAGRAM_\d+\]/g);
                if (remainingMarkers) {
                } else {
                    console.log(`‚úÖ All diagram markers successfully replaced`);
                }
            }

            // Add Diagrams if available
            if (data.diagram_positions && data.diagram_positions.length > 0) {
                const diagContainer = document.createElement('div');
                diagContainer.className = 'diagram-container';
                diagContainer.style.display = 'flex';
                diagContainer.style.flexWrap = 'wrap';
                diagContainer.style.gap = '20px';
                diagContainer.style.marginTop = '20px';
                diagContainer.style.justifyContent = 'center';

                data.diagram_positions.forEach(pos => {
                    const wrapper = document.createElement('div');
                    wrapper.style.textAlign = 'center';

                    const img = document.createElement('img');
                    img.src = `/board?fen=${encodeURIComponent(pos.fen)}`;
                    img.style.width = '300px';
                    img.style.height = '300px';
                    img.style.border = '2px solid #444';

                    const label = document.createElement('div');
                    label.innerText = pos.title;
                    label.style.color = '#ccc';
                    label.style.marginTop = '5px';
                    label.style.fontSize = '0.9em';

                    wrapper.appendChild(img);
                    wrapper.appendChild(label);
                    diagContainer.appendChild(wrapper);
                });

                resultsDiv.prepend(diagContainer);
            }

            if (data.results && Array.isArray(data.results)) {
                data.results.forEach((result, idx) => {
                    if (!result.epub_diagrams || result.epub_diagrams.length === 0) {
                        console.warn(`‚ö†Ô∏è Result ${idx + 1} (${result.book_name || result.book}) has no epub diagrams`);
                    }
                });
            }

            // Render processed answer with both FEN diagrams and featured EPUB diagrams
            const renderedAnswer = applyBasicMarkdown(processedAnswer);
            renderAnswerWithDiagrams(renderedAnswer, data.diagram_positions || [], answerContainer);

            // Display sources section
            const sourcesSection = document.createElement('div');
            sourcesSection.className = 'sources-section';
            sourcesSection.innerHTML = `
                <h3 onclick="toggleSources()" style="cursor: pointer; user-select: none;">
                    üìö View Sources (<span id="source-count">${data.sources.length}</span> books)
                    <span id="sources-toggle">‚ñº</span>
                </h3>
                <div id="sources-list" style="display: none;"></div>
            `;
            resultsDiv.appendChild(sourcesSection);

            // Populate sources
            const sourcesList = document.getElementById('sources-list');
            data.sources.forEach((source, index) => {
                const sourceCard = createSourceCard(source, index);
                sourcesList.appendChild(sourceCard);
            });

            // Add performance stats if available
            if (data.timing) {
                console.log('Query timing:', data.timing);
                const perfSection = document.createElement('div');
                perfSection.className = 'performance-stats';
                perfSection.style.cssText = 'margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 0.9em;';

                const timing = data.timing;
                perfSection.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 8px;">‚è±Ô∏è Performance Metrics:</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                        ${timing.embedding ? `<div>Embedding: <strong>${timing.embedding}s</strong></div>` : ''}
                        ${timing.search ? `<div>Search: <strong>${timing.search}s</strong></div>` : ''}
                        ${timing.reranking ? `<div>Reranking: <strong>${timing.reranking}s</strong></div>` : ''}
                        ${timing.rrf_merge ? `<div>RRF Merge: <strong>${timing.rrf_merge}s</strong></div>` : ''}
                        ${timing.synthesis ? `<div>Synthesis: <strong>${timing.synthesis}s</strong></div>` : ''}
                        ${timing.diagrams ? `<div>Diagrams: <strong>${timing.diagrams}s</strong></div>` : ''}
                        ${timing.total ? `<div style="grid-column: 1 / -1; border-top: 1px solid #ddd; padding-top: 8px; margin-top: 8px;">Total: <strong>${timing.total}s</strong></div>` : ''}
                    </div>
                `;
                resultsDiv.appendChild(perfSection);
            }
        }

        function formatAnswerText(text) {
            // Convert newlines to paragraphs
            return '<p>' + text.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
        }

        function applyBasicMarkdown(text) {
            if (!text) {
                return '';
            }
            // Bold (**text**)
            let formatted = text.replace(/\*\*([\s\S]+?)\*\*/g, '<strong>$1</strong>');
            return formatted;
        }

        function toggleSources() {
            const sourcesList = document.getElementById('sources-list');
            const toggle = document.getElementById('sources-toggle');
            if (sourcesList.style.display === 'none') {
                sourcesList.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                sourcesList.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }

        function createSourceCard(source, index) {
            const card = document.createElement('div');
            card.className = 'source-item';

            const bookName = source.book_name || source.book || 'Unknown Book';
            const score = source.score || 0;
            const rrfScore = source.rrf_score ? (source.rrf_score * 100).toFixed(2) : '0.00';
            const text = source.text || source.content || '';
            const chapterTitle = source.chapter_title || source.chapter || '';

            // Determine collection type for badge
            const collection = source.collection || '';
            const isEpub = collection.includes('production');
            const isPgn = collection.includes('pgn');
            const collectionBadge = isPgn ? '‚ôüÔ∏è PGN' : (isEpub ? 'üìñ EPUB' : '');
            const badgeColor = isPgn ? '#FF9800' : '#2196F3';

            card.innerHTML = `
                <div class="source-header">
                    <span class="source-number">${index + 1}.</span>
                    <span class="source-score">Relevance: (${score}/10) / RRF: (${rrfScore})</span>
                    ${collectionBadge ? `<span class="collection-badge" style="background: ${badgeColor}; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.85em; margin-left: 8px;">${collectionBadge}</span>` : ''}
                    <div class="source-book-info">
                        <div class="source-book">${escapeHtml(bookName)}</div>
                        ${chapterTitle ? `<div class="source-chapter">${escapeHtml(chapterTitle)}</div>` : ''}
                    </div>
                </div>
                <div class="source-text">${escapeHtml(text)}</div>
            `;

            // Add chess positions if they exist
            if (source.has_positions && source.positions && source.positions.length > 0) {
                const positionsDiv = document.createElement('div');
                positionsDiv.className = 'chess-positions';
                positionsDiv.innerHTML = '<div class="position-header">‚ôü Chess Positions Found:</div>';

                source.positions.forEach((position, posIndex) => {
                    const posItem = createPositionItem(position, `board-source-${index}-${posIndex}`);
                    positionsDiv.appendChild(posItem);
                });

                card.appendChild(positionsDiv);
            }

            return card;
        }

        function createResultCard(result, index) {
            const card = document.createElement('div');
            card.className = 'result-card';

            // Header with score and metadata
            const header = document.createElement('div');
            header.className = 'result-header';
            header.innerHTML = `
                <div class="result-score">${result.score}/10</div>
                <div class="result-meta">
                    <div class="result-book">${escapeHtml(result.book)}</div>
                    <div class="result-chapter">${escapeHtml(result.chapter)}</div>
                </div>
            `;
            card.appendChild(header);

            // Text content
            const text = document.createElement('div');
            text.className = 'result-text';
            text.textContent = result.text.substring(0, 500) + (result.text.length > 500 ? '...' : '');
            card.appendChild(text);

            // Chess positions (if any)
            if (result.has_positions && result.positions.length > 0) {
                const positionsDiv = document.createElement('div');
                positionsDiv.className = 'chess-positions';
                positionsDiv.innerHTML = '<div class="position-header">‚ôü Chess Positions Found:</div>';

                result.positions.forEach((position, posIndex) => {
                    const posItem = createPositionItem(position, `board-${index}-${posIndex}`);
                    positionsDiv.appendChild(posItem);
                });

                card.appendChild(positionsDiv);
            }

            // Phase 6.1a: Static EPUB diagrams (if any)
            if (result.epub_diagrams && result.epub_diagrams.length > 0) {
                const diagramsDiv = document.createElement('div');
                diagramsDiv.className = 'epub-diagrams-section';

                const header = document.createElement('div');
                header.className = 'diagrams-header';
                header.textContent = `üì∑ ${result.epub_diagrams.length} diagram(s) from "${result.epub_diagrams[0].book_title}"`;
                diagramsDiv.appendChild(header);

                const grid = document.createElement('div');
                grid.className = 'diagram-grid';

                result.epub_diagrams.forEach((diagram, diagIndex) => {
                    const item = document.createElement('div');
                    item.className = 'diagram-item';

                    const img = document.createElement('img');
                    img.src = diagram.url;
                    img.alt = diagram.caption;
                    img.loading = 'lazy';
                    img.onerror = function () { this.style.display = 'none'; };  // Silent fail
                    item.appendChild(img);

                    const caption = document.createElement('p');
                    caption.className = 'diagram-caption';
                    caption.textContent = diagram.caption;
                    item.appendChild(caption);

                    grid.appendChild(item);
                });

                diagramsDiv.appendChild(grid);
                card.appendChild(diagramsDiv);
            }

            return card;
        }

        function createPositionItem(position, boardId) {
            const item = document.createElement('div');
            item.className = 'position-item';

            // Render SVG board (server-side generated)
            if (position.svg) {
                const boardContainer = document.createElement('div');
                boardContainer.className = 'chessboard-container';
                boardContainer.innerHTML = position.svg;
                item.appendChild(boardContainer);
            }

            // Lichess link
            const lichessLink = document.createElement('a');
            lichessLink.className = 'lichess-btn';
            lichessLink.href = `https://lichess.org/analysis/${encodeURIComponent(position.fen)}`;
            lichessLink.target = '_blank';
            lichessLink.textContent = 'üìä Analyze on Lichess';
            item.appendChild(lichessLink);

            // FULL caption (NOT TRUNCATED)
            if (position.caption) {
                const caption = document.createElement('div');
                caption.className = 'position-caption';
                caption.textContent = position.caption;
                item.appendChild(caption);
            }

            return item;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
    <script>
        // --- Live Stats Poller ---
        async function updateStats() {
            try {
                const response = await fetch('/stats');
                const data = await response.json();

                // Animate/Update numbers
                document.getElementById('book-count').innerText = data.epubs.toLocaleString();
                document.getElementById('chunk-count').innerText = data.chunks.toLocaleString();
                document.getElementById('game-count').innerText = data.pgn_games.toLocaleString();
                document.getElementById('total-count').innerText = (data.chunks + data.pgn_games).toLocaleString();

            } catch (e) {
                console.error("Stats poll failed", e);
            }
        }

        // Poll every 3 seconds to show "explosive" growth
        setInterval(updateStats, 3000);
        updateStats(); // Initial call
    </script>
</body>

</html>