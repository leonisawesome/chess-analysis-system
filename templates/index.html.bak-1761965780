<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System A: Chess Knowledge Search</title>

    <!-- Chessboard.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <!-- Chess Diagram Renderer CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/diagrams.css') }}">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .subtitle {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .search-box {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .search-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .search-btn {
            background: #3498db;
            color: white;
            padding: 15px 40px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .search-btn:hover {
            background: #2980b9;
        }

        .search-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #7f8c8d;
        }

        .results {
            margin-top: 30px;
        }

        .result-card {
            background: white;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .result-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .result-score {
            background: #27ae60;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            font-weight: bold;
            margin-right: 15px;
        }

        .result-meta {
            flex: 1;
        }

        .result-book {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .result-chapter {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .result-text {
            line-height: 1.8;
            margin-bottom: 20px;
            white-space: pre-wrap;
        }

        .chess-positions {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .position-header {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .position-item {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .chessboard-container {
            max-width: 400px;
            margin: 15px 0;
        }

        .lichess-btn {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .lichess-btn:hover {
            background: #2980b9;
        }

        .position-context {
            font-size: 0.9em;
            color: #555;
            margin-top: 10px;
            font-style: italic;
        }

        .position-caption {
            margin: 15px 0;
            padding: 15px;
            background: #fff;
            border-left: 3px solid #3498db;
            font-size: 14px;
            color: #555;
            line-height: 1.7;
            border-radius: 4px;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        /* Synthesized answer section */
        .synthesized-answer {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .answer-content {
            font-size: 16px;
            line-height: 1.8;
            color: #2c3e50;
        }

        .answer-content p {
            margin-bottom: 16px;
        }

        .answer-content p:last-child {
            margin-bottom: 0;
        }

        /* Sources section */
        .sources-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .sources-section h3 {
            margin: 0 0 15px 0;
            color: #666;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .source-item {
            background: white;
            padding: 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .source-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }

        .source-number {
            font-weight: bold;
            color: #666;
            font-size: 18px;
            min-width: 24px;
        }

        .source-score {
            background: #4CAF50;
            color: white;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 14px;
            flex-shrink: 0;
        }

        .source-book-info {
            flex: 1;
            min-width: 0;
        }

        .source-book {
            color: #2c3e50;
            font-size: 13px;
            font-weight: 500;
            word-wrap: break-word;
            margin-bottom: 4px;
        }

        .source-chapter {
            color: #7f8c8d;
            font-size: 12px;
            font-style: italic;
        }

        .source-text {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Answer positions section */
        .answer-positions {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .answer-positions h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .answer-positions .position-item {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .answer-positions .chessboard-container {
            max-width: 400px;
            margin: 0 auto 15px auto;
        }

        .answer-positions .lichess-btn {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
            transition: background 0.3s;
            margin-bottom: 10px;
        }

        .answer-positions .lichess-btn:hover {
            background: #2980b9;
        }

        .answer-positions .position-context {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üè∞ System A: Chess Knowledge Search</h1>
            <p class="subtitle">357,957 chunks from 1,052 instructional chess books</p>
        </div>
    </header>

    <div class="container">
        <div class="search-box">
            <input
                type="text"
                id="queryInput"
                class="search-input"
                placeholder="Ask a chess question... (e.g., How do I improve my calculation in the middlegame?)"
                onkeypress="if(event.key === 'Enter') search()"
            >
            <button class="search-btn" onclick="search()" id="searchBtn">
                Search
            </button>
        </div>

        <div id="loading" class="loading" style="display: none;">
            ‚è≥ Searching 357,957 chunks, reranking, and synthesizing answer with GPT-5... (this may take 50-60 seconds)
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="results" class="results" style="display: none;"></div>
    </div>

    <!-- jQuery (required for chessboard.js) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Chess.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <!-- Chessboard.js -->
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <!-- Chess Diagram Renderer -->
    <script src="{{ url_for('static', filename='js/diagram-renderer.js') }}"></script>

    <script>
        function search() {
            console.log("=== SEARCH FUNCTION CALLED ===");
            const query = document.getElementById('queryInput').value.trim();
            console.log("Query:", query);

            if (!query) {
                alert('Please enter a question');
                return;
            }

            // Show loading, hide error and results
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('results').innerHTML = '';
            document.getElementById('searchBtn').disabled = true;

            console.log("Sending POST request to /query...");

            // Send query to backend
            fetch('/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query })
            })
            .then(response => {
                console.log("Response received:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("Data received:", data);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;

                if (data.error) {
                    showError(data.error);
                    return;
                }

                displayResults(data);
            })
            .catch(error => {
                console.error("FETCH ERROR:", error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('searchBtn').disabled = false;
                showError('An error occurred: ' + error.message);
            });
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function displayResults(data) {
            // DEBUG: Log received data
            console.log("=== RECEIVED DATA ===");
            console.log("Data keys:", Object.keys(data));
            console.log("Has diagram_positions:", 'diagram_positions' in data);
            if (data.diagram_positions) {
                console.log("Number of diagram_positions:", data.diagram_positions.length);
                if (data.diagram_positions.length > 0) {
                    console.log("First diagram:", data.diagram_positions[0]);
                }
            }
            console.log("Answer contains [DIAGRAM_ID_X]?", /\[DIAGRAM_ID_\d+\]/.test(data.answer));
            console.log("=== END DATA ===");

            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';

            if (!data.answer || !data.sources) {
                resultsDiv.innerHTML = '<p class="loading">No results found</p>';
                return;
            }

            // Create answer section container
            const answerSection = document.createElement('div');
            answerSection.className = 'synthesized-answer';
            answerSection.innerHTML = `
                <h2 style="color: #2c3e50; margin-bottom: 20px;">Answer</h2>
                <div class="answer-content" id="answer-content-container"></div>
            `;
            resultsDiv.appendChild(answerSection);

            // Use diagram renderer to replace markers and inject diagrams
            const answerContainer = document.getElementById('answer-content-container');
            renderAnswerWithDiagrams(data.answer, data.diagram_positions || [], answerContainer);

            // Display sources section
            const sourcesSection = document.createElement('div');
            sourcesSection.className = 'sources-section';
            sourcesSection.innerHTML = `
                <h3 onclick="toggleSources()" style="cursor: pointer; user-select: none;">
                    üìö View Sources (<span id="source-count">${data.sources.length}</span> books)
                    <span id="sources-toggle">‚ñº</span>
                </h3>
                <div id="sources-list" style="display: none;"></div>
            `;
            resultsDiv.appendChild(sourcesSection);

            // Populate sources
            const sourcesList = document.getElementById('sources-list');
            data.sources.forEach((source, index) => {
                const sourceCard = createSourceCard(source, index);
                sourcesList.appendChild(sourceCard);
            });

            // Log timing if available
            if (data.timing) {
                console.log('Query timing:', data.timing);
            }
        }

        function formatAnswerText(text) {
            // Convert newlines to paragraphs
            return '<p>' + text.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>') + '</p>';
        }

        function toggleSources() {
            const sourcesList = document.getElementById('sources-list');
            const toggle = document.getElementById('sources-toggle');
            if (sourcesList.style.display === 'none') {
                sourcesList.style.display = 'block';
                toggle.textContent = '‚ñ≤';
            } else {
                sourcesList.style.display = 'none';
                toggle.textContent = '‚ñº';
            }
        }

        function createSourceCard(source, index) {
            const card = document.createElement('div');
            card.className = 'source-item';

            const bookName = source.book_name || source.book || 'Unknown Book';
            const score = source.score || 0;
            const text = source.text || '';
            const chapterTitle = source.chapter_title || source.chapter || '';

            card.innerHTML = `
                <div class="source-header">
                    <span class="source-number">${index + 1}.</span>
                    <span class="source-score">${score}/10</span>
                    <div class="source-book-info">
                        <div class="source-book">${escapeHtml(bookName)}</div>
                        ${chapterTitle ? `<div class="source-chapter">${escapeHtml(chapterTitle)}</div>` : ''}
                    </div>
                </div>
                <div class="source-text">${escapeHtml(text)}</div>
            `;

            // Add chess positions if they exist
            if (source.has_positions && source.positions && source.positions.length > 0) {
                const positionsDiv = document.createElement('div');
                positionsDiv.className = 'chess-positions';
                positionsDiv.innerHTML = '<div class="position-header">‚ôü Chess Positions Found:</div>';

                source.positions.forEach((position, posIndex) => {
                    const posItem = createPositionItem(position, `board-source-${index}-${posIndex}`);
                    positionsDiv.appendChild(posItem);
                });

                card.appendChild(positionsDiv);
            }

            return card;
        }

        function createResultCard(result, index) {
            const card = document.createElement('div');
            card.className = 'result-card';

            // Header with score and metadata
            const header = document.createElement('div');
            header.className = 'result-header';
            header.innerHTML = `
                <div class="result-score">${result.score}/10</div>
                <div class="result-meta">
                    <div class="result-book">${escapeHtml(result.book)}</div>
                    <div class="result-chapter">${escapeHtml(result.chapter)}</div>
                </div>
            `;
            card.appendChild(header);

            // Text content
            const text = document.createElement('div');
            text.className = 'result-text';
            text.textContent = result.text.substring(0, 500) + (result.text.length > 500 ? '...' : '');
            card.appendChild(text);

            // Chess positions (if any)
            if (result.has_positions && result.positions.length > 0) {
                const positionsDiv = document.createElement('div');
                positionsDiv.className = 'chess-positions';
                positionsDiv.innerHTML = '<div class="position-header">‚ôü Chess Positions Found:</div>';

                result.positions.forEach((position, posIndex) => {
                    const posItem = createPositionItem(position, `board-${index}-${posIndex}`);
                    positionsDiv.appendChild(posItem);
                });

                card.appendChild(positionsDiv);
            }

            return card;
        }

        function createPositionItem(position, boardId) {
            const item = document.createElement('div');
            item.className = 'position-item';

            // Render SVG board (server-side generated)
            if (position.svg) {
                const boardContainer = document.createElement('div');
                boardContainer.className = 'chessboard-container';
                boardContainer.innerHTML = position.svg;
                item.appendChild(boardContainer);
            }

            // Lichess link
            const lichessLink = document.createElement('a');
            lichessLink.className = 'lichess-btn';
            lichessLink.href = `https://lichess.org/analysis/${encodeURIComponent(position.fen)}`;
            lichessLink.target = '_blank';
            lichessLink.textContent = 'üìä Analyze on Lichess';
            item.appendChild(lichessLink);

            // FULL caption (NOT TRUNCATED)
            if (position.caption) {
                const caption = document.createElement('div');
                caption.className = 'position-caption';
                caption.textContent = position.caption;
                item.appendChild(caption);
            }

            return item;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
